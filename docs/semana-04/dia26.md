---
title: D√≠a 26 - Estado remoto y colaboraci√≥n
description: Estado remoto, backends y colaboraci√≥n en equipo con Terraform
sidebar_position: 5
---

## üåê Estado de Terraform y Trabajo en Equipo

![](../../static/images/banner/4.png)

¬°Hoy aprenderemos a trabajar en equipo con Terraform!  
Exploraremos el **estado de Terraform**, **workspaces** y c√≥mo **colaborar** de forma segura en proyectos reales.

---

## üéØ Objetivo del D√≠a

**Entender el estado de Terraform y configurar workspaces para gestionar m√∫ltiples ambientes de forma segura.**

---

## üìä ¬øQu√© es el Estado de Terraform?

El **estado** (`terraform.tfstate`) es un archivo que Terraform usa para:

- üó∫Ô∏è **Recordar** qu√© recursos ha creado
- üîç **Mapear** tu c√≥digo con la infraestructura real
- üöÄ **Optimizar** operaciones (sabe qu√© cambiar)
- üîÑ **Detectar** cambios externos

### Veamos el Estado en Acci√≥n

```bash
# Crear un recurso simple
echo 'resource "local_file" "example" {
  filename = "hello.txt"
  content  = "Hello from Terraform!"
}' > main.tf

# Aplicar
terraform init
terraform apply

# Ver el estado
terraform show
cat terraform.tfstate
```

El archivo `terraform.tfstate` contiene informaci√≥n como:
```json
{
  "version": 4,
  "terraform_version": "1.6.0",
  "resources": [
    {
      "type": "local_file",
      "name": "example",
      "instances": [
        {
          "attributes": {
            "filename": "hello.txt",
            "content": "Hello from Terraform!"
          }
        }
      ]
    }
  ]
}
```

---

## ‚ö†Ô∏è Problemas del Estado Local

### 1. **No se puede compartir**
```bash
# ‚ùå Problema: Solo en tu m√°quina
# Tu compa√±ero no puede ver qu√© has desplegado
# No pueden trabajar juntos en el mismo proyecto
```

### 2. **Se puede perder**
```bash
# ‚ùå Problema: Si borras el archivo por error
rm terraform.tfstate
terraform plan  # Ya no sabe qu√© recursos existen!
```

### 3. **Conflictos en equipo**
```bash
# ‚ùå Problema: Dos personas ejecutan terraform al mismo tiempo
# Persona A: terraform apply (modificando estado)
# Persona B: terraform apply (modificando estado al mismo tiempo)
# = Estado corrupto
```

---

## üè¢ Workspaces: M√∫ltiples Ambientes

Los **workspaces** permiten tener **m√∫ltiples estados** en el mismo c√≥digo:

### Conceptos B√°sicos

```bash
# Ver workspace actual
terraform workspace show
# Output: default

# Listar todos los workspaces
terraform workspace list
# Output: 
# * default

# Crear nuevo workspace para desarrollo
terraform workspace new dev
# Output: Created and switched to workspace "dev"!

# Crear workspace para producci√≥n
terraform workspace new prod

# Cambiar entre workspaces
terraform workspace select dev
terraform workspace select prod
terraform workspace select default
```

### Ejemplo Pr√°ctico con Workspaces

#### `main.tf`
```hcl
terraform {
  required_providers {
    local = {
      source  = "hashicorp/local"
      version = "~> 2.0"
    }
  }
}

# El contenido cambia seg√∫n el workspace
resource "local_file" "app_config" {
  filename = "app-${terraform.workspace}.conf"
  content = <<-EOF
    [Application]
    environment = ${terraform.workspace}
    debug = ${terraform.workspace == "dev" ? "true" : "false"}
    port = ${terraform.workspace == "dev" ? "8080" : "80"}
    
    [Database]
    host = ${terraform.workspace}-db.example.com
    name = app_${terraform.workspace}
  EOF
}

# Output que muestra informaci√≥n del workspace
output "environment_info" {
  value = {
    workspace = terraform.workspace
    filename  = local_file.app_config.filename
    is_dev    = terraform.workspace == "dev"
    is_prod   = terraform.workspace == "prod"
  }
}
```

### Probando los Workspaces

```bash
# Workspace de desarrollo
terraform workspace select dev
terraform apply
cat app-dev.conf

# Workspace de producci√≥n  
terraform workspace select prod
terraform apply
cat app-prod.conf

# Ver las diferencias
terraform workspace select dev
terraform output

terraform workspace select prod
terraform output
```

---

## üê≥ Ejemplo con Docker y Workspaces

Vamos a crear una aplicaci√≥n que se comporta diferente en cada ambiente:

### `variables.tf`
```hcl
variable "app_name" {
  description = "Nombre de la aplicaci√≥n"
  type        = string
  default     = "mi-app"
}

# Configuraci√≥n por workspace usando locals
locals {
  # Configuraci√≥n espec√≠fica por ambiente
  env_config = {
    dev = {
      replica_count = 1
      memory_mb     = 256
      external_port = 8080
      image_tag     = "dev"
    }
    staging = {
      replica_count = 2
      memory_mb     = 512
      external_port = 8081
      image_tag     = "staging"
    }
    prod = {
      replica_count = 3
      memory_mb     = 1024
      external_port = 80
      image_tag     = "latest"
    }
  }
  
  # Configuraci√≥n actual basada en el workspace
  current_config = local.env_config[terraform.workspace]
  
  # Nombre √∫nico por ambiente
  container_name = "${var.app_name}-${terraform.workspace}"
}
```

### `main.tf`
```hcl
terraform {
  required_providers {
    docker = {
      source  = "kreuzwerker/docker"
      version = "~> 3.0"
    }
  }
}

provider "docker" {}

# Imagen de nginx
resource "docker_image" "nginx" {
  name         = "nginx:${local.current_config.image_tag}"
  keep_locally = false
}

# Red espec√≠fica por ambiente
resource "docker_network" "app_network" {
  name = "${local.container_name}-network"
}

# Contenedores seg√∫n configuraci√≥n del ambiente
resource "docker_container" "app" {
  count = local.current_config.replica_count
  
  name  = "${local.container_name}-${count.index + 1}"
  image = docker_image.nginx.image_id
  
  # Puerto solo en el primer contenedor
  dynamic "ports" {
    for_each = count.index == 0 ? [1] : []
    content {
      internal = 80
      external = local.current_config.external_port
    }
  }
  
  # Variables de entorno
  env = [
    "ENVIRONMENT=${terraform.workspace}",
    "REPLICA_ID=${count.index + 1}",
    "TOTAL_REPLICAS=${local.current_config.replica_count}"
  ]
  
  # L√≠mites de recursos
  memory = local.current_config.memory_mb
  
  # Conectar a la red
  networks_advanced {
    name = docker_network.app_network.name
  }
  
  # Labels para identificar
  labels {
    label = "environment"
    value = terraform.workspace
  }
  
  labels {
    label = "managed-by"
    value = "terraform"
  }
}
```

### `outputs.tf`
```hcl
output "app_info" {
  description = "Informaci√≥n de la aplicaci√≥n desplegada"
  value = {
    environment   = terraform.workspace
    app_url       = "http://localhost:${local.current_config.external_port}"
    replica_count = local.current_config.replica_count
    memory_per_container = "${local.current_config.memory_mb}MB"
    container_names = docker_container.app[*].name
    network_name = docker_network.app_network.name
  }
}

output "quick_commands" {
  description = "Comandos √∫tiles para este ambiente"
  value = {
    view_logs = "docker logs ${local.container_name}-1"
    connect_container = "docker exec -it ${local.container_name}-1 /bin/bash"
    test_app = "curl http://localhost:${local.current_config.external_port}"
    list_containers = "docker ps --filter label=environment=${terraform.workspace}"
  }
}
```

---

## üéÆ Probando M√∫ltiples Ambientes

### 1. Desarrollo
```bash
# Crear y usar workspace dev
terraform workspace new dev
terraform init
terraform apply

# Verificar
terraform output
curl http://localhost:8080
docker ps --filter label=environment=dev
```

### 2. Staging
```bash
# Cambiar a staging
terraform workspace new staging
terraform apply

# Verificar - nota el puerto diferente
terraform output
curl http://localhost:8081
docker ps --filter label=environment=staging
```

### 3. Producci√≥n
```bash
# Cambiar a producci√≥n
terraform workspace new prod
terraform apply

# Verificar - 3 contenedores, puerto 80
terraform output
curl http://localhost:80
docker ps --filter label=environment=prod
```

### 4. Ver Todo Junto
```bash
# Ver todos los contenedores de todos los ambientes
docker ps --filter label=managed-by=terraform

# Ver workspaces
terraform workspace list

# Limpiar ambiente espec√≠fico
terraform workspace select dev
terraform destroy

# Los otros ambientes siguen funcionando
terraform workspace select prod
terraform show
```

---

## ü§ù Colaboraci√≥n en Equipo (Conceptos)

### Estado Compartido Simple

#### Usando un Directorio Compartido
```hcl
# En versions.tf
terraform {
  backend "local" {
    path = "/shared/projects/mi-app/terraform.tfstate"
  }
}
```

#### Estructura para Equipo
```
proyecto-equipo/
‚îú‚îÄ‚îÄ shared-state/           # Directorio compartido en red
‚îÇ   ‚îú‚îÄ‚îÄ dev.tfstate
‚îÇ   ‚îú‚îÄ‚îÄ staging.tfstate
‚îÇ   ‚îî‚îÄ‚îÄ prod.tfstate
‚îú‚îÄ‚îÄ environments/           # Configuraciones por ambiente
‚îÇ   ‚îú‚îÄ‚îÄ dev.tfvars
‚îÇ   ‚îú‚îÄ‚îÄ staging.tfvars
‚îÇ   ‚îî‚îÄ‚îÄ prod.tfvars
‚îú‚îÄ‚îÄ scripts/               # Scripts del equipo
‚îÇ   ‚îú‚îÄ‚îÄ deploy-dev.sh
‚îÇ   ‚îú‚îÄ‚îÄ deploy-staging.sh
‚îÇ   ‚îî‚îÄ‚îÄ status.sh
‚îú‚îÄ‚îÄ main.tf
‚îú‚îÄ‚îÄ variables.tf
‚îî‚îÄ‚îÄ README.md              # Documentaci√≥n del equipo
```

---

## üìù Scripts para Colaboraci√≥n

### `scripts/deploy-dev.sh`
```bash
#!/bin/bash
echo "üöÄ Desplegando a desarrollo..."

# Cambiar al workspace correcto
terraform workspace select dev || terraform workspace new dev

# Aplicar con variables espec√≠ficas
terraform apply -var-file="environments/dev.tfvars"

echo "‚úÖ Desarrollo desplegado!"
echo "üåê URL: http://localhost:8080"
```

### `scripts/status.sh`
```bash
#!/bin/bash
echo "üìä Estado de todos los ambientes"
echo "================================"

for env in dev staging prod; do
    echo ""
    echo "üè∑Ô∏è Ambiente: $env"
    
    if terraform workspace select $env 2>/dev/null; then
        echo "   Estado: $(terraform workspace show)"
        
        # Verificar si hay recursos
        resource_count=$(terraform state list 2>/dev/null | wc -l)
        echo "   Recursos: $resource_count"
        
        # Verificar contenedores
        containers=$(docker ps -q --filter label=environment=$env | wc -l)
        echo "   Contenedores activos: $containers"
    else
        echo "   ‚ùå Workspace no existe"
    fi
done
```

### `environments/dev.tfvars`
```hcl
# Configuraci√≥n para desarrollo
app_name = "voting-app"

# Las configuraciones espec√≠ficas est√°n en locals
# Este archivo puede tener overrides si es necesario
```

---

## üö® Buenas Pr√°cticas

### 1. **Naming Conventions**
```bash
# ‚úÖ Nombres consistentes
terraform workspace new dev
terraform workspace new staging  
terraform workspace new prod

# ‚ùå Evitar nombres confusos
terraform workspace new development-environment-v2
```

### 2. **Documentaci√≥n**
```markdown
# README.md del proyecto
## Ambientes Disponibles

- **dev**: Desarrollo local (puerto 8080)
- **staging**: Testing (puerto 8081) 
- **prod**: Producci√≥n (puerto 80)

## Comandos R√°pidos

```bash
# Desplegar a dev
./scripts/deploy-dev.sh

# Ver estado
./scripts/status.sh

# Cambiar ambiente
terraform workspace select [dev|staging|prod]
```

### 3. **Estado Seguro**
```bash
# ‚úÖ Hacer backups regularmente
cp terraform.tfstate terraform.tfstate.backup-$(date +%Y%m%d)

# ‚úÖ No versionar archivos .tfstate
echo "*.tfstate*" >> .gitignore
echo ".terraform/" >> .gitignore

# ‚úÖ Usar workspaces para separar ambientes
terraform workspace select prod  # Solo para prod
```

---

## üõ†Ô∏è Comandos √ötiles para el D√≠a a D√≠a

### Gesti√≥n de Workspaces
```bash
# Ver workspace actual
terraform workspace show

# Listar workspaces
terraform workspace list

# Crear workspace
terraform workspace new nombre

# Cambiar workspace
terraform workspace select nombre

# Eliminar workspace (debe estar vac√≠o)
terraform workspace delete nombre
```

### Verificaci√≥n de Estado
```bash
# Ver recursos en el workspace actual
terraform state list

# Ver detalles de un recurso
terraform state show docker_container.app[0]

# Ver toda la configuraci√≥n aplicada
terraform show

# Ver outputs
terraform output
terraform output app_info
```

### Debugging
```bash
# Verificar qu√© workspace est√°s usando
echo "Workspace actual: $(terraform workspace show)"

# Ver el plan antes de aplicar
terraform plan

# Aplicar solo recursos espec√≠ficos
terraform apply -target=docker_container.app

# Ver logs detallados
TF_LOG=INFO terraform apply
```

---

## üí° Ejercicio Pr√°ctico

### Desaf√≠o: Gestionar 3 Ambientes

1. **Crear el proyecto**
```bash
mkdir terraform-workspaces-practice
cd terraform-workspaces-practice
```

2. **Implementar la configuraci√≥n** (usar los ejemplos de arriba)

3. **Crear los 3 ambientes**
```bash
terraform workspace new dev
terraform apply

terraform workspace new staging  
terraform apply

terraform workspace new prod
terraform apply
```

4. **Verificar que todo funciona**
```bash
# Dev en puerto 8080 (1 contenedor)
curl http://localhost:8080

# Staging en puerto 8081 (2 contenedores)  
curl http://localhost:8081

# Prod en puerto 80 (3 contenedores)
curl http://localhost:80
```

5. **Experimentar con cambios**
```bash
# Hacer cambio en c√≥digo
# Aplicar solo a dev
terraform workspace select dev
terraform apply

# Los otros ambientes no se afectan
terraform workspace select prod
terraform show  # Sin cambios
```

---

## ‚úÖ ¬øQu√© Aprendiste Hoy?

‚úÖ **Qu√© es el estado** de Terraform y por qu√© es importante  
‚úÖ **Problemas del estado local** y trabajo en equipo  
‚úÖ **Workspaces** para gestionar m√∫ltiples ambientes  
‚úÖ **Configuraci√≥n din√°mica** basada en workspace  
‚úÖ **Colaboraci√≥n b√°sica** en equipos  
‚úÖ **Buenas pr√°cticas** para organizaci√≥n  
‚úÖ **Comandos esenciales** para el d√≠a a d√≠a  

---

## üîÆ ¬øQu√© Sigue Ma√±ana?

Ma√±ana en el **D√≠a 27** aprenderemos sobre:
- CI/CD con GitHub Actions
- Automatizaci√≥n de despliegues
- Pipelines para m√∫ltiples ambientes
- Validaci√≥n autom√°tica

---

## üéØ Conceptos Clave para Recordar

1. **El estado es crucial** - Terraform necesita saber qu√© ha creado
2. **Workspaces = ambientes** - Un workspace = un ambiente
3. **terraform.workspace** - Variable especial para l√≥gica condicional
4. **Separaci√≥n clara** - dev/staging/prod deben estar separados
5. **Colaboraci√≥n** - El estado debe ser compartible en equipos

---

**üí¨ Comparte tu progreso en la comunidad con el hashtag #DevOpsConRoxs**

¬°Excelente trabajo dominando workspaces y colaboraci√≥n! üåêüéâ